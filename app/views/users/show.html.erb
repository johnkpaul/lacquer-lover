<h1 id="top"><%= image_tag @user.image || 'placeholder-avatar.png', size: '50x50' %> <%= @user.first_name %></h1>

<% if (@user != current_user) && (!current_user.all_friends.include?(@user)) %>
	<%= link_to "Add Friend", new_friendship_path(friend_id: @user) %><br>
<% end %>

<div class="row">
	<!-- PUBLIC PROFILE -->
	<div class="col-sm-4" id="public-profile">
		<h3>Lacquers: <%= @user.lacquers.count %></h3>
		<h3>Friends: <%= @user.accepted_friends.count %></h3>
		<% if !@user.lacquers_added_by.empty? %>
			<% if @user == current_user %>
				<h3>Lacquers Added by You</h3>
			<% else %>
				<h3>Lacquers Added by <%= @user.name %></h3>
			<% end %>
			<ul>
			<% @user.lacquers_added_by.each do |lacquer| %>
				<li><%= link_to lacquer.name, lacquer_path(lacquer) %> (<%= link_to lacquer.brand.name, brand_path(lacquer.brand) %>)</li>
			<% end %>
			</ul>
		<% end %>

		<% if @user.owned_transactions %>
			<% if @user == current_user %>
				<h3>Your Loan Count: 
			<% else %>
				<h3><%= @user.name %>’s Loan Count: 
			<% end %>
			<%= @user.owned_transactions.count %></h3>
		<% end %>

		<% if @user.requested_transactions %>
			<% if @user == current_user %>
				<h3>Your Borrow Count: 
			<% else %>
				<h3><%= @user.name %>’s Borrow Count: 
			<% end %>
			<%= @user.requested_transactions.count %></h3>
		<% end %>
	</div>
	<!-- END OF PUBLIC PROFILE -->


	<!-- BEGINNING OF YOUR ALERTS & FRIENDSHIPS (IF YOU ARE THE CURRENT USER) -->

		<div class="col-sm-3">
			<h3>Friends</h3>
			<% if @user.accepted_friends.count > 0 %>
				<% @user.accepted_friends.each do |friend| %>
					<p style="font-size:20px;"><%= image_tag friend.image || 'placeholder-avatar.png', size: '50x50' %> <%= link_to friend.name, user_path(friend) %></p>
				<% end %>
			<% end %>

			<h3>Favorites</h3>
			<% if @user.favorited_lacquers.count > 0 %>
				<ul>
				<% @user.favorited_lacquers.each do |favorite| %>
					<li style="font-size:20px;"><%= link_to favorite.name, lacquer_path(favorite) %></li>
				<% end %>
				</ul>
			<% end %>
		</div>
	
	<% if @user == current_user %>

	<span class="live-notifications">
		<div class="col-sm-5">
			<!-- FRIENDSHIPS YOU NEED TO TAKE ACTION ON -->
			<% if @user.friendships_for_your_approval.count > 0 %>
				<h3>Friendships Awaiting Your Approval</h3>
				<ul>
					<% @user.friendships_for_your_approval.each do |friendship| %>
						<% friend = User.find(friendship.user_id) %>
						<li style='padding-top: 15px;'><%= link_to friend.name, user_path(friend) %><br> <%= link_to "Accept", friendship_path(friendship, :state => 'accepted'), {:method => "PATCH", :class =>"btn btn-success btn-xs"} %> <%= link_to "Reject", friendship_path(friendship, :state => 'rejected'), {:method => "PATCH", :class =>"btn btn-danger btn-xs"} %></li>
					<% end %>
				</ul>
			<% end %>
			<!-- END OF FRIENDSHIPS YOU NEED TO TAKE ACTION ON -->

			<!-- FRIENDSHIPS YOU'VE REQUESTED NOT YET APPROVED -->
			<% if @user.requested_friends_awaiting_approval.count > 0 %>
				<h3>Your Pending Friend Requests</h3>
				<ul>
					<% @user.requested_friends_awaiting_approval.each do |friend| %>
						<% friendship = Friendship.where(user_id: @user.id, friend_id: friend.id).first %>
						<li style='padding-top: 15px;'><%= link_to friend.name, user_path(friend) %></li>
						<%= link_to 'Cancel Request', friendship_path(friendship), method: 'DELETE', :class =>"btn btn-default btn-xs" %>
					<% end %>
				</ul>
			<% end %>
			<!-- END OF FRIENDSHIPS YOU'VE REQUESTED NOT YET APPROVED -->

			<!-- RECTED FRIENDSHIPS YOU'VE REQUESTED -->
			<% if @user.rejected_friend_requests.count > 0 %>
				<h3>Sorry, these friend requests were not approved.</h3>
				<ul>
					<% @user.rejected_friend_requests.each do |friendship| %>
						<% friend = User.find(friendship.friend_id) %>
						<li style='padding-top: 15px;'><%= link_to friend.name, user_path(friend) %></li>
						<%= link_to "conclude this request", friendship_path(friendship, :state => 'concluded'), {:method => "PATCH", :class =>"btn btn-warning btn-xs"} %>
					<% end %>
				</ul>
			<% end %>
			<!-- END OF RECTED FRIENDSHIPS YOU'VE REQUESTED -->

			<!-- TRANSACTIONS YOU OWN -->
			<% if @user.owned_transactions.count > 0 %>

				<!-- TRANSACTIONS AWAITING YOUR APPROVAL -->
				<% if @user.transactions_for_your_approval.count > 0 %>
					<h3>Transactions Awaiting Your Approval</h3>
					<ul>
					<% @user.transactions_for_your_approval.each do |transaction| %>
						<% friend = User.find(transaction.requester_id) %>
						<% lacquer = Lacquer.find(transaction.user_lacquer.lacquer_id) %>
						<li style='padding-top: 15px;'><%= link_to friend.name, user_path(friend) %> has asked to borrow <%= lacquer.name %>.</br> <%= link_to "Accept Request", transaction_path(transaction, :state => 'accepted'), {:method => "PATCH", :class =>"btn btn-success btn-xs"} %> <%= link_to "Reject Request", transaction_path(transaction, :state => 'rejected'), {:method => "PATCH", :class =>"btn btn-danger btn-xs"} %></li>
					<% end %>
					</ul>
				<% end %>
				<!-- END OF TRANSACTIONS AWAITING YOUR APPROVAL -->

				<!-- TRANSACTIONS YOU'VE ACCEPTED BUT NOT GIVEN OUT YET -->
				<% if @user.transactions_you_accepted.count > 0 %>
					<h3>Transactions You Accepted</h3>
					<ul>
					<% @user.transactions_you_accepted.each do |transaction| %>
						<% friend = transaction.requester %>
						<% lacquer = transaction.lacquer %>
						<li style='padding-top: 15px;'>
							You've agreed to loan <%= lacquer.name %> out to <%= link_to friend.name, user_path(friend) %>.<br> <%= link_to "I gave #{lacquer.name} to #{friend.name}", transaction_path(transaction, :state => 'active', :date_became_active => Date.today), {:method => "PATCH", :class =>"btn btn-info btn-xs"} %>
						</li>
						<%= form_for transaction do |f| %>
							<%= f.label :due_date, "Add or Update Due Date" %>
							<%= f.date_field :due_date %>
							<%= f.submit :class =>"btn btn-info btn-xs" %>
						<% end %> 
					<% end %>
					</ul>
				<% end %>
				<!-- END OF TRANSACTIONS YOU'VE ACCEPTED BUT NOT GIVEN OUT YET -->

				<!-- CURRENTLY LOANED OUT -->
				<% if @user.active_owned_transactions.count > 0 %>
					<h3>Lacquers Currenly on Loan</h3>
					<ul>
					<% @user.active_owned_transactions.each do |transaction| %>
						<% friend = User.find(transaction.requester_id) %>
						<% lacquer = Lacquer.find(transaction.user_lacquer.lacquer_id) %>
						<li style='padding-top: 15px;'>
							Your <%= lacquer.name %> is currently loaned out to <%= link_to friend.name, user_path(friend) %>.<br> <%= link_to "#{friend.name} gave #{lacquer.name} back", transaction_path(transaction, :state => 'completed'), {:method => "PATCH", :class =>"btn btn-info btn-xs"} %>
						</li>
						<%= form_for transaction do |f| %>
							<%= f.label :due_date, "Add or Update Due Date" %>
							<%= f.date_field :due_date %>
							<%= f.submit :class =>"btn btn-info btn-xs" %>
						<% end %> 
					<% end %>
					</ul>
				<% end %>
				<!-- END OF CURRENTLY LOANED OUT -->
			<% end %>
			<!-- END OF TRANSACTIONS YOU OWN -->

			<!-- TRANSACTIONS YOU'VE REQUESTED -->
			<% if @user.requested_transactions.count > 0 %>
			
				<!-- CURRENTLY LOANED OUT TO YOU -->
				<% if @user.active_requested_transactions.count > 0 %>
					<h3>Lacquers Currently Loaned Out to You</h3>
					<ul>
						<% @user.active_requested_transactions.each do |transaction| %>
							<% friend = User.find(transaction.owner_id) %>
							<% lacquer = Lacquer.find(transaction.user_lacquer.lacquer_id) %>
							<li style='padding-top: 15px;'>
								<%= link_to friend.name, user_path(friend) %> gave you <%= lacquer.name %> on <%= transaction.date_became_active.strftime("%m/%d/%Y") %>.
								<% if transaction.due_date %>
									<% if transaction.overdue? %>
										<div class="alert alert-danger" role="alert" style="padding: 2px;">
										You're <%= pluralize(transaction.days_overdue, 'day') %> overdue to return this lacquer. Don't mess with karma - give it back!
										</div>
									<% elsif transaction.due_today? %>
									<div class="alert alert-dismissable alert-warning" style="padding: 2px;">
              
										Remember to give this lacquer back <strong>today</strong>!
									</div>
									<% elsif transaction.due_tomorrow? %>
									<div class="alert alert-dismissable alert-success" style="padding: 2px;">
										Remember to give this lacquer back <strong>tomorrow</strong>!
									</div>
									<% else %>
										The return date for this loan is <%= transaction.due_date.strftime("%m/%d/%Y") %>.
									<% end %>
								<% end %>
							</li>
						<% end %>
					</ul>
				<% end %>
				<!-- END OF CURRENTLY LOANED OUT TO YOU -->

				<!-- LOANS REQUESTED ACCEPTED NOT ACTIVE YET -->
				<% if @user.accepted_requested_transactions.count > 0 %>
					<h3>Accepted Loan Requests</h3>
					<ul>
					<% @user.accepted_requested_transactions.each do |transaction| %>
						<% friend = User.find(transaction.owner_id) %>
						<% lacquer = Lacquer.find(transaction.user_lacquer.lacquer_id) %>
						<li style='padding-top: 15px;'><%= link_to friend.name, user_path(friend) %> has agreed to loan you <%= lacquer.name %>.</li>
					<% end %>
					</ul>
				<% end %>
				<!-- END LOANS REQUESTED ACCEPTED NOT ACTIVE YET -->

				<!-- LOANS REQUESTED PENDING -->
				<% if @user.pending_requested_transactions.count > 0 %>
					<h3>Pending Loan Requests</h3>
					<ul>
					<% @user.pending_requested_transactions.each do |transaction| %>
						<% friend = User.find(transaction.owner_id) %>
						<% lacquer = Lacquer.find(transaction.user_lacquer.lacquer_id) %>
						<li style='padding-top: 15px;'>You've asked <%= link_to friend.name, user_path(friend) %> to loan you <%= lacquer.name %></li>
						<%= link_to 'Cancel Pending Request', transaction_path(transaction), method: 'DELETE', :class =>"btn btn-default btn-xs" %>
					<% end %>
					</ul>
				<% end %>
				<!-- END LOANS REQUESTED PENDING -->

				<!-- LOAN REQUESTS REJECTED -->
				<% if @user.rejected_requested_transactions.count > 0 %>
					<h3>Pending Loan Requests</h3>
					<ul>
					<% @user.rejected_requested_transactions.each do |transaction| %>
						<% friend = User.find(transaction.owner_id) %>
						<% lacquer = Lacquer.find(transaction.user_lacquer.lacquer_id) %>
						<li style='padding-top: 15px;'>It seems <%= link_to friend.name, user_path(friend) %> isn't able to loan you <%= lacquer.name %> at this time.</li>
						<%= link_to "conclude this request", transaction_path(transaction, :state => 'completed'), {:method => "PATCH", :class =>"btn btn-warning btn-xs"} %>
					<% end %>
					</ul>
				<% end %>
				<!-- END LOAN REQUESTS REJECTED -->

			<% end %>
			<!-- END OF TRANSACTIONS YOU'VE REQUESTED -->
		
		</div>
	</span>
	<% end %>
</div>
<!-- END OF YOUR ALERTS (IF YOU ARE THE CURRENT USER) -->
	

<% if (@user == current_user) || (current_user.accepted_friends.include?(@user)) %>
	<section>
	<div class="page-header">
		<% if @user == current_user %>
			<h3>Your Lacquers</h1>
			<h5>Add A Lacquer</h5>
			<div class="dropdown">
			  <select id="brand-selection" class="btn-default">
			    <option value="hasnt-been-chosen">Choose your brand</option>
			    <% Brand.order(:name).each do |brand| %>
			    	<option value="<%= brand.name %>"><%= brand.name %></option>
			    <% end %>
			  </select>
			</div>

			<% Brand.all.each do |brand| %>
				<div class="lacquer-dropdown dropdown btn" id="<%= brand.abbreviation %>-dropdown">
				  <%= form_for @new_user_lacquer, :url => url_for(:controller => 'user_lacquers', :action => 'create'), remote: true do |f| %>

				  	<%= f.select(:lacquer_id, brand.lacquers.order(:name).collect {|p| [ p.name, p.id ] } + [ [ 'Other', 'new' ] ], {:prompt => "Select an #{brand.name} lacquer"}, :class => "btn-default") %>

				    <%= f.submit value: "add this polish", :class => "add-lacquer btn disabled" %>
				  <% end %>
				</div>
			<% end %>

			<!-- ADD "OTHER" LACQUER FOR DEBORAH -->
			<% Brand.all.each do |brand| %>
				<% new_lacquer = brand.lacquers.new %>
			<div class="other-lacquer" id="<%= brand.abbreviation %>">
				<%= form_for new_lacquer, :url => url_for(:controller => 'lacquers', :action => 'create'), remote: true do |f| %>
					<%= f.label :name %>
					<%= f.text_field :name, placeholder: "lacquer name", :required => true %>

    			<%= fields_for new_lacquer.user_lacquers.new do |user_lacquer_form| %>
						<div class="btn-group">
				    	<button type="button" class="btn btn-default dropdown-toggle color-dropdown" data-toggle="dropdown" aria-expanded="false">
					    	Select Colors <span class="caret"></span>
	  					</button>
		 					<ul class="dropdown-menu" role="menu" id="color-dropdown" style="padding: 10px;">
		 					<%= user_lacquer_form.collection_check_boxes :color_ids, Color.all, :id, :name do |b| %>
	  							<%= b.check_box %> <%= b.label %><br>
							<% end %>
		    			</ul>
	    			</div>
	    			<div class="btn-group">
				    	<button type="button" class="btn btn-default dropdown-toggle finish-dropdown" data-toggle="dropdown" aria-expanded="false">
					    	Select Finishes <span class="caret"></span>
	  					</button>
		 					<ul class="dropdown-menu" role="menu" id="finish-dropdown" style="padding: 10px;">
		    			<%= user_lacquer_form.collection_check_boxes :finish_ids, Finish.all, :id, :description do |b| %>
	  							<%= b.check_box %> <%= b.label %><br>
							<% end %>
		    			</ul>
		 
	    			</div>
	    			<div class="add-new-lacquer-to-collection">
		 						<%= user_lacquer_form.label "Add this lacquer to my collection." %>
		    				<%= check_box_tag :user_id, current_user.id, required: true %>
		    		<% end %>	
		    		</div>
		    		<%= f.hidden_field :brand_id, value: new_lacquer.brand_id %>
		    		<%= f.hidden_field :user_added_by_id, value: current_user.id %>
						<%= f.submit "Create Lacquer" %>
					<% end %>
				</div>
			<% end %>
			<!-- END OF ADD "OTHER" LACQUER FOR DEBORAH -->

		<!-- ***** END OF ADD OTHER LACQUERS ***** --> 	

		<% else %>
			<h3><%= @user.first_name %>'s Lacquers</h3>
		<% end %>
	</div>
	<div class="row" id="filter-buttons" style="background-color: #DCDCDC; padding: 10px; text-align: center;">
		<% brands = @user.lacquers.collect {|l| l.brand.name}.uniq %>
		<% colors = @user.lacquers.collect {|l| l.color_tags}.flatten.uniq %>
		<% finishes = @user.lacquers.collect {|l| l.finish_tags}.flatten.uniq %>
		<% attributes = {"brands" => brands, "colors" => colors, "finishes" => finishes} %>
		<!-- <div class="row" style="text-align:center;"> -->
		<% attributes.each do |attribute, items| %>
			<div class="<%=attribute%>-buttons col-xs-4">
			<% if !items.empty? %>
			  <% items.each do |item| %>
			    <%= link_to "#{item}", "#", :class => "btn btn-xs btn-default #{attribute}", :id => "#{item}", :style => "margin: 2px;" %>
			  <% end %>
			<% else %>
				<h6>No <%= attribute %> in <%= @user.name %>'s collection.</h6>
			<% end %>
		  </div>
		<% end %>
		<!-- </div> -->
	</div>
	<table class="table table-striped table-hover" id="user-lacquer-collection">
		<thead>
			<tr class="selected color-selected finish-selected">
				<th>Swatch</th>
				<th>Brand</th>
				<th></th>
				<th>Name</th>
				<th>Colors</th>
				<th>Finishes</th>
				<% if @user == current_user %>
					<th>Loanable?</th>
					<th>On Loan?</th>
					<th>Edit/Remove</th>
				<% else %>
					<th>Loan Requests</th>
				<% end %>
			</tr>
		</thead>
		<tbody>
		<% @user_lacquers.each do |user_lacquer| %>
  		<tr class="user-lacquer-partial" lacquer-id="<%= user_lacquer.lacquer.id %>" user-lacquer-id="<%= user_lacquer.id %>" id="<%=user_lacquer.id%>">
  		</tr>
		<% end %>
		</tbody>
	</table>
	</section>
	
<p style="float: right;"><a href='#top' class="btn btn-xs btn-primary">back to top</a></p>
<% end %>

<% if @user == current_user %>
	<%= link_to "Export collection as JSON", user_path( id: @user.id, format: :json ), class: "btn btn-xs btn-info" %>
<% end %>
